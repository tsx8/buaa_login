name: Nix CI

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - '**.nix'
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'flake.lock'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main", "master" ]

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false

      - name: Run Statix (Nix linter)
        run: nix run nixpkgs#statix -- check .

      - name: Check Nix formatting
        run: nix run nixpkgs#nixfmt-rfc-style -- --check *.nix

      - name: Check Flake
        run: nix flake check -v

      - name: Build Default Package
        run: nix build -L

      - name: Verify Build Output
        run: ./result/bin/buaa-login --help || true

      - name: Run NixOS VM Test
        run: nix build .#checks.x86_64-linux.vm-test -L
